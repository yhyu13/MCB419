<!DOCTYPE html>
<!--
Created using JS Bin
http://jsbin.com

Copyright (c) 2017 by yhyu13 (http://jsbin.com/yiqiyuc/32/edit)

Released under the MIT license: http://jsbin.mit-license.org
-->
<meta name="robots" content="noindex">
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.6/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.6/addons/p5.dom.min.js"></script>
  <script src="https://rawgit.com/yhyu13/MCB419/master/FInal%20Project-James%20Bond/deepqlearn.js"></script>
  <script src="https://rawgit.com/yhyu13/MCB419/master/FInal%20Project-James%20Bond/convnet.js"></script>
  <script src="https://rawgit.com/yhyu13/MCB419/master/FInal%20Project-James%20Bond/util.js"></script>
  <title>MCB 419</title>
<style id="jsbin-css">
body {
  font-family: Ariel, Helvetica;
  line-height: 130%;
  padding: 10px;
}
button {
  margin: 5px;
}
code {
  font-size: 130%;
  color: Blue;
}
li {
  margin: 10px 0;
}
table,
th,
td {
  border: 1px solid gray;
  border-collapse: collapse;
  padding: 5px;
}
</style>
</head>

<body>
   <h2>MCB 419 Project Hang (Yohan) Yu:  Reinfocrement Learning---Dodge, Feast, Temperature, and Electric Fence</h2>
  <pre>
  <b>due date:</b> Tue Apr 25 by 9:00 PM
  <b>email to:</b> mcb419@gmail.com
  <b>subject:</b> draft project
  <b>email contents:</b>
    1) jsbin.com link to your draft project (clone this file)
  </pre>
  <p style="color:blue; font-size:130%">
    This is the final project of MCB419 based on HW4 & HW13, which are bacteria kinesis and neural network reinforcement learning (NNRL). I call it "Dodge, Feast Temperature, and Electric Fence". They are the four elements of the enviornment that I built for the agent. Let's see what it can do!
  </p>
  <div id="canvas"></div>
  <div id="status" style="color: blue; margin-bottom: 20px"></div>
  <div id="gui"></div>
  <div id="myQ"></div>
  <h3>Introduction</h3>
  <p>This introduction goes in a form of Q & A:
  <br>1) Q: What is the goal, the inspiration, what does it build on (e.g., is it an extension of a previous hw assignment)? 
   <br>A: <b> I'm always inspired by Q-learning because it reminds me that even a simple idea can be pwoerful. This project is based on a extension of HW13 (neural network reinforcement learning) and HW4 (bacteria kinesis on a vraious temperature gradient)</b>
  <br>2) Q: What general information processing principles will be incorporated? 
    <br>A: <b>The agent has 12 sensors. Based on the fact that the agent is a circle (no rotation), there is are four sensors on the <font color=	#BC8F8F>"north, south, west, and east"</font> edges of the agent, and each one of them return two values -- the overall accumulation of the inverse of distances (so that values goes larger when pellets get closer) between the agent and <font color=	#7FFF00>green pellets</font> and the same thing for the <font color="red">red pellets</font>. There is one sensor called <font color=#FFD700>"wall"</font> that returns the inverse of distance between the agent and the cloest wall. And there is one sensor for temperature. The rest two are a little bit tricky: they are called <font color=#FF1493>"close"</font>, which return the inverse of distances only for pellets within 100 distance threshold (such that the agent is able to better prioritize pellets that are close which it either cosume or dodge.)The agent has 5 actions: <font color=#BC8F8F>[up,down,left,right,stop]</font> which correspond to <font color=	#BC8F8F>[W, S, A, D, Space]</font>. The agent moves at peak speed of 2.5 units per frame, and pellets usually move faster than the agent. The agent learns by neural network with Q-learning (credit to: "http://www.life.illinois.edu	#BC8F8F/mcb/419/lib/deepqlearn.js" )</b>
  <br>3) Q: What hypothesis or hypotheses do you plan to test?  What data will you collect?  What comparisons will you make? 
    <br>A: <b> The agent chases rewards and avoids pain, which means it shall stay in high temperature region while consume good(green) pellets and dodge bad(red) pellets (elective option: electric fence). The agent should have a trade-off/combination between staying in <font color="red">high temperature</font> and chase <font color=	#7FFF00>green pellets</font>. To evaluate the performance of the agent, the mean/std of energy, the mean/std of comsuption of bad pellets, and the mean/std of time stays in high temperature region will be collected. I will compare with 'keyboard', 'randAction', and 'traning'.</b>  
  <br>4) Q: What is your measure of success for the project? 
    <br>A: <b>It used be: <font color=#FF00FF>Whether or not the agent can beat me hard!</font>, which I thought is fun. Bur at this moment, I'd rather put my peer's opion in the first place becuase their voice is more honest and valuable than my self-fulfilment.</b>
  </p>

  <h3>Model description / Methods</h3>
  <p>Describe specific implementation details here. It's important to have a well-defined specification before you start coding.
  Ideally you should make these detailed enough so that somebody else could read them and have enough information to recreate the model.
  (NOTE: you don't necessarily have to stick to these as the project develops. Most likely there will likely be changes,
  but this gives you a good starting point.)
  </p>
  <ul>
    <li><b>Environment:</b> key features of the environment
    </li><li><b>Agent(s):</b> key features of the agent(s) in the model <b> The agent uses Deep Q-learning to gain reward and avoid pain in a relatively complex enviroment.</b>
  </li><li><b>Sensors:</b> sensory system description; describe sensor types, number, coding, etc. <b> (Described above)</b>
  </li><li><b>Actions:</b> motor system description; describe the actions that the agent can execute <b> (Described above)</b>
  </li><li><b>Controller:</b> describe the controller architecture (e.g. FSM, neural network), what are the free/adjustable parameters? <b> The number of hidden layers, the number of nuerons and activation fucntions, and leanring rate, batch size, etc.</b>
  </li><li><b>Adaptation:</b> will the system evolve or learn to improve performance? If so, how. <b> The agent will first collect enough experience. Then randomly retrive those experience (DeepMind calls it dream?) and try to avoid actions that leads lower reward and excute actions that obtain gains. Finally, through ~100 iterations, the agent shall behave better than a human player.</b>
  </li><li><b>Multi-agent interactions:</b> describe interactions between agents if relevant (communication, predator-prey, mating, etc.) <b> None</b>
  </li><li><b>Graphical design:</b> how do you plan to represent the above elements on the screen <b> (Showed above: in progess)</b>
  </li><li><b>User-interface:</b> how will the user interact with the model <b> Users can either play with keyboard or mouse. They also train network and either save or load existing networks.</b>
  </li><li><b>Quantitative analysis:</b> how will you present and analyze the results (tables, graphs, histograms) <b> (The table below)</b>
  </li><li><b>More</b> ...anything else you want to add... <b> It must be fun!XD</b>
  </li></ul>

  <h3>Javascript code organization</h3>
  <p>Given the specifications above, outline how you plan to organize your javascript code. What javascript objects and methods will you need to write?  <b> There isn't much to add but there are a lot to be modified (see comment in Js).</b>

  <h3>Progress Report / Milestones</h3>
  <p>How much have you already accomplished? What do you have left to do? 
  Provide a brief list of key subgoals and target dates that will help move you toward your final goal.
  </p>
  <h3>Results Table</h3>
  <table>
    <tr><th>Controller</th><th>Energy<br><small>mean (std dev)</small></th></tr>
    <tbody id="table">
    </tbody>
  </table>
  <h3>Additional information</h3>
  <p>Feel free to expand here with any other details that are important for your project.</p>
  
  
  
    <div id="gui2"><p>Scene1</p></div>
  <br>
  <textarea id="scene1" style="width:100%; height:200px;">
{"layers":[{"out_depth":12,"out_sx":1,"out_sy":1,"layer_type":"input"},{"out_depth":20,"out_sx":1,"out_sy":1,"layer_type":"fc","num_inputs":12,"l1_decay_mul":0,"l2_decay_mul":1,"filters":[{"sx":1,"sy":1,"depth":12,"w":{"0":-0.30888105677901023,"1":-0.20069416780494054,"2":0.15203850054277382,"3":0.043963075230875566,"4":-0.06302275300117924,"5":0.2248768967280716,"6":0.358908020632894,"7":-0.12709714011345533,"8":-0.5350506728559101,"9":-0.3022127331842889,"10":0.4004089034023762,"11":-1.411668440904958}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.10599259164058117,"1":0.024547923443667217,"2":-0.048800360803117476,"3":0.2025316371533698,"4":0.5017978394794983,"5":0.429242344905404,"6":0.16758264501209252,"7":0.10691192429047422,"8":-0.1041986762718703,"9":-0.11962547354331049,"10":0.42065730911355176,"11":-0.18644252713639564}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.3028116377586034,"1":0.1689798400310473,"2":0.39832110335971316,"3":0.2665661566299122,"4":0.05674372683022525,"5":0.18054858122442008,"6":0.237527278467958,"7":0.026500211340993556,"8":0.15812117596014202,"9":0.06186033742675695,"10":-0.4966917235393025,"11":-1.1336192268339227}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.6916546905431904,"1":0.41195568876636496,"2":-0.4720495329120632,"3":0.01390758207191696,"4":-0.014170131019159152,"5":-0.23787723220392118,"6":0.14209248978745606,"7":0.22083476060256504,"8":0.11171387877778326,"9":-0.25433083256681976,"10":-0.3688541017970137,"11":-1.117824303496986}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.023389600731074562,"1":0.3254988192770915,"2":-0.1554871341630658,"3":0.25761454140192197,"4":-0.08917152063724917,"5":-0.3376147701594859,"6":-0.32198812949147226,"7":-0.03485004335493139,"8":0.07495309101195688,"9":-0.060582751656662395,"10":0.16607854671289313,"11":-0.613735468250203}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.2984026625139301,"1":0.379818113013207,"2":0.030356007703898902,"3":-0.10921348613687897,"4":-0.011143820662349925,"5":0.34913249734156043,"6":0.20260504154808412,"7":0.1197568841828866,"8":0.0313485982445772,"9":-0.3243177859796154,"10":0.5206439200808678,"11":-2.2747940723954243}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.3483216566816179,"1":-0.46538394987980586,"2":0.11208845295343865,"3":0.5046370219012073,"4":-0.19648615576031297,"5":0.04732602499724103,"6":0.22802100353405508,"7":0.06498067619194484,"8":0.2952382975313712,"9":0.46418110228405035,"10":-0.4068860110873523,"11":2.628537150300399}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.23764301781690092,"1":0.11939661076855534,"2":-0.41245470083227853,"3":-0.298147019250571,"4":-0.06846813592900067,"5":-0.46327503009392296,"6":0.016077698053543928,"7":0.11070346597393929,"8":-0.3017707741190484,"9":0.06558634931234349,"10":-0.14453731861875743,"11":0.9800732648067249}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.2613170504568814,"1":-0.09034645624776437,"2":-0.13071912405667227,"3":-0.26886588664923833,"4":-0.11615677023741815,"5":-0.11213394944058018,"6":-0.482731178172697,"7":-0.09803477650485791,"8":-0.033726583528454854,"9":0.24066019674037098,"10":0.05447484999552829,"11":1.2599551980466954}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.34136481841057803,"1":-0.22053093668533966,"2":0.05383296883060748,"3":0.09954933009140501,"4":0.4445553877314578,"5":0.17307459309183712,"6":0.567146037303812,"7":0.2425771636121021,"8":0.3103019711018421,"9":-0.20574643389887665,"10":-0.45236867235768696,"11":-0.839458671405519}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.15134303625314763,"1":-0.35303814080354773,"2":-0.195131835632028,"3":-0.6000218346021529,"4":-0.1203379359384565,"5":0.36495068646193796,"6":0.5265666641925084,"7":0.35370813966507575,"8":-0.3709993128387831,"9":0.14800651538131385,"10":-0.036979281636850624,"11":1.4026272922951266}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.03043089141195319,"1":0.14834714287072012,"2":0.1982080444283694,"3":-0.26004376697462445,"4":-0.2166562347213377,"5":-0.08270748900574583,"6":-0.24479785247068028,"7":-0.20715960907281472,"8":0.11393905841084782,"9":0.25821582115539893,"10":0.18471701722863235,"11":-1.170155833855953}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.05556584074827971,"1":-0.39059454432826707,"2":-0.12102161448563285,"3":-0.1881981267723958,"4":-0.04916268738094727,"5":-0.0427649557851732,"6":-0.0063231132499624925,"7":-0.06803544345726459,"8":-0.08373393566197196,"9":-0.05291032730321869,"10":-0.7491439281655042,"11":0.45475244479718374}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.018877385781661118,"1":-0.1300744710715978,"2":-0.14121455822478932,"3":0.065728898912314,"4":0.20827775955499178,"5":0.40354901620948125,"6":-0.4828300293176087,"7":-0.3299210795025476,"8":0.3766940968559549,"9":0.25407746610512516,"10":0.4069009155791893,"11":-0.07844601192362313}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.08204540913709489,"1":-0.02199366011409,"2":-0.4550040695368212,"3":-0.1259976799351718,"4":0.04495815548227666,"5":0.2717927232439243,"6":-0.0029948392339355285,"7":0.3436015766360093,"8":0.23953021027952698,"9":0.02220059296098309,"10":-0.03896033041572731,"11":-0.4234071326917025}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.10300829155044215,"1":0.27783526039127404,"2":0.09232881229743678,"3":0.3812582215153205,"4":0.22949349481035958,"5":0.06080005897340131,"6":-0.043879240064396696,"7":-0.08984450508937476,"8":-0.02619731115935827,"9":-0.2253167294472868,"10":0.3656196625612655,"11":-0.9215752443248603}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.10852400828916757,"1":0.36361182155441824,"2":0.27135281946158096,"3":-0.26004932740822384,"4":0.10765178041833662,"5":0.10584027161800962,"6":-0.4015361035104825,"7":0.2278376045859586,"8":0.18128521744466145,"9":-0.1528841198595174,"10":-0.03487959552164118,"11":0.20862958587919794}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.27958766883792746,"1":-0.23789402672524154,"2":0.08014079410641287,"3":-0.2082698225542569,"4":0.09489172030123891,"5":0.15582715625228993,"6":-0.024406314864958388,"7":-0.0428532205197572,"8":-0.23305587259925495,"9":-0.5736891232790062,"10":0.3519387448069034,"11":-2.9295527874690643}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.3601138763945242,"1":-0.007822663537759959,"2":0.016497094451533526,"3":-0.09357821204679234,"4":-0.21588854423438691,"5":-0.36040879499913925,"6":0.34779364158077913,"7":0.22650819628975646,"8":-0.167298138481509,"9":0.11033918865326059,"10":-0.00719271842219245,"11":-0.42150085769619955}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.37923770674939955,"1":0.08466411070949434,"2":-0.5104934808939222,"3":-0.16633148502621586,"4":0.010891206397182836,"5":-0.1945562723256986,"6":-0.34448805683775946,"7":-0.37999986346562864,"8":0.02376549133430471,"9":0.450087595367087,"10":-0.06991604193903486,"11":1.5004819469795572}}],"biases":{"sx":1,"sy":1,"depth":20,"w":{"0":0.09481514128384289,"1":-0.004448403690011344,"2":-0.02424168655160196,"3":-0.08132792078825242,"4":-0.02519293324479034,"5":-0.21299255586783988,"6":0.09192027648362491,"7":0.006215643613857117,"8":0.08209766383672626,"9":0.04113483290877628,"10":0.008283034285340924,"11":-0.022670853589696397,"12":0.003104138120646581,"13":-0.1010617785609424,"14":0.0013491651890402108,"15":-0.006997947818540832,"16":0.036761937518073884,"17":0.04431343965078142,"18":-0.01279514746207095,"19":0.12641240587686867}}},{"out_depth":5,"out_sx":1,"out_sy":1,"layer_type":"fc","num_inputs":20,"l1_decay_mul":0,"l2_decay_mul":1,"filters":[{"sx":1,"sy":1,"depth":20,"w":{"0":-0.6869268772165648,"1":-0.23459642469205752,"2":-0.5811722494375373,"3":-0.7631604226294001,"4":-0.46171077466926097,"5":-1.0947191654833641,"6":1.1818271660548554,"7":0.3744757803594233,"8":0.24182322431631076,"9":-0.36408441843018996,"10":0.37624650516162855,"11":-0.5403610911833354,"12":0.4054876109698372,"13":-0.022999083909904634,"14":-0.14902217018807604,"15":-0.21540159021628444,"16":-0.11402624364469095,"17":-1.3326413093200788,"18":-0.3023874405089698,"19":0.7648394835913407}},{"sx":1,"sy":1,"depth":20,"w":{"0":-0.6834804819749151,"1":-0.03705679275242784,"2":-0.40052558908070907,"3":-0.4586805283870561,"4":-0.21037313852271713,"5":-0.8364810767946481,"6":1.2898716681567768,"7":0.39964024102416845,"8":0.4599193732036111,"9":-0.553740739693906,"10":0.5984505666878441,"11":-0.7926195441410319,"12":0.3657724918515459,"13":-0.045735672458702276,"14":-0.39386307386062436,"15":-0.5840575979448436,"16":0.1358367189223045,"17":-1.2088298566316331,"18":0.05894702640834932,"19":0.7036744933583203}},{"sx":1,"sy":1,"depth":20,"w":{"0":-0.5472389120915921,"1":-0.26521688788420666,"2":-0.44624944362916863,"3":-0.3751983148856718,"4":-0.07584280203364385,"5":-1.1130309909322296,"6":1.0262771333483807,"7":0.4838378538974436,"8":0.668230800542194,"9":-0.19552748073764786,"10":0.7246883646759316,"11":-0.3956541676296538,"12":0.188209845013188,"13":-0.0014266102130424184,"14":-0.32485240283845274,"15":-0.30335811588943845,"16":0.19422343186898716,"17":-1.5074492939884434,"18":-0.10218868396541779,"19":0.7584369657461185}},{"sx":1,"sy":1,"depth":20,"w":{"0":-0.5897400163023387,"1":0.047744189177091445,"2":-0.54090043247084,"3":-0.5218460738003835,"4":-0.20274426985648028,"5":-1.159586472130579,"6":1.3077520025177307,"7":0.5193576450948773,"8":0.5898743676808489,"9":-0.28657916581174514,"10":0.6661575932592312,"11":-0.3501822227697248,"12":0.34297044068890636,"13":-0.059541444436356734,"14":-0.17035436492881334,"15":-0.2969397803840002,"16":-0.0026957746576352325,"17":-1.1565377606207274,"18":-0.16653563169272376,"19":0.6089744272696869}},{"sx":1,"sy":1,"depth":20,"w":{"0":-0.4106888865863004,"1":-0.1629422154210087,"2":-0.3655346408730492,"3":-0.5477999117293073,"4":-0.49001208106401306,"5":-1.309332622632358,"6":1.2112195136149426,"7":0.3977311511448359,"8":0.854425707495918,"9":-0.22018356644964107,"10":0.6458753416251418,"11":-0.4004691998902325,"12":-0.015358537314430593,"13":-0.2407566620953479,"14":0.11924319157699854,"15":-0.7925185306506911,"16":0.17053205838829527,"17":-1.0237138368820695,"18":-0.36515096663490254,"19":0.7220293664410163}}],"biases":{"sx":1,"sy":1,"depth":5,"w":{"0":0.13143911354949364,"1":0.12590316293657314,"2":0.15919220732793896,"3":0.1298198413427529,"4":0.13891352373748378}}},{"out_depth":5,"out_sx":1,"out_sy":1,"layer_type":"regression","num_inputs":5}]}

   </textarea>
  
  
  
  
  
  
  <div id="gui3"><p>Scene2</p></div>
  <br>
  <textarea id="scene2" style="width:100%; height:200px;">
{"layers":[{"out_depth":12,"out_sx":1,"out_sy":1,"layer_type":"input"},{"out_depth":20,"out_sx":1,"out_sy":1,"layer_type":"fc","num_inputs":12,"l1_decay_mul":0,"l2_decay_mul":1,"filters":[{"sx":1,"sy":1,"depth":12,"w":{"0":0.2852680320291895,"1":-0.21099147085910258,"2":0.44726730429927336,"3":0.057908794911777146,"4":-0.31577885463759925,"5":-0.20044223676255388,"6":0.13542056198226382,"7":0.30424614383753534,"8":0.13399380763415006,"9":-0.1808825469130281,"10":-0.14058925332943661,"11":0.4544675925565006}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.07894859511495954,"1":0.0070881500780925625,"2":-0.11492215200956028,"3":-0.37892845210552345,"4":0.04727891176398129,"5":-0.2780244650936333,"6":-0.12058523519189406,"7":0.42720270118997566,"8":0.2278157830481108,"9":-0.5129744587961472,"10":0.13663304199057177,"11":-0.8118873334578103}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.3151853072402488,"1":-0.36317757219350666,"2":-0.3492292550057058,"3":-0.062309514300987516,"4":0.3955908531043579,"5":-0.19201335273357428,"6":-0.21040601210403917,"7":0.42222272039130165,"8":-0.49378341952893906,"9":0.016960780128020526,"10":-0.11037401968743475,"11":-0.3207370250237647}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.3682729597959999,"1":0.0782544953047797,"2":-0.09667012369546552,"3":0.6633419741038229,"4":0.1728374736446502,"5":-0.09319528332605037,"6":-0.39009083841275916,"7":-0.14271136261372722,"8":0.23901220311865373,"9":-0.44286339347490794,"10":-0.34040617340980267,"11":0.06152710465294248}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.013368924818845109,"1":-0.1718057839076708,"2":-0.09377552697649577,"3":-0.2000400411595801,"4":0.15801042166385293,"5":0.22617061523921334,"6":-0.5044616080830426,"7":-0.10717526692333194,"8":-0.1876293442219076,"9":-0.07911470032554899,"10":-0.0536060737090499,"11":-0.24506968640547008}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.38041292779187924,"1":0.21000183083850607,"2":-0.05123762994608116,"3":0.7539796472381399,"4":-0.25497711732180933,"5":0.1510065036302374,"6":-0.08012730230705495,"7":0.45494273836024135,"8":-0.20310559820658453,"9":0.45713036663320006,"10":-0.35908212924963195,"11":-0.2391508924553791}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.4249247170247202,"1":-0.330362194802465,"2":0.04987461004028229,"3":-0.28123479098858944,"4":-0.07712118824070315,"5":0.43371733480385594,"6":-0.14954270844492434,"7":-0.08368343474725305,"8":-0.3767324751387569,"9":0.0773931652968972,"10":0.21697479163532044,"11":0.2459667815162186}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.22854537630047786,"1":-0.31606703356390503,"2":-0.2807071526793775,"3":0.055338773581352134,"4":0.49790015342311367,"5":0.07691494997296545,"6":0.08519812691500826,"7":-0.4452210702174695,"8":0.457694021261959,"9":0.3239898992334953,"10":-0.3103658487141914,"11":0.06474177935468187}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.14257481936978736,"1":0.028756061524890467,"2":-0.12188384736476751,"3":0.1631096923003776,"4":0.03757437374950163,"5":-0.5470986163340026,"6":-0.03622705131339136,"7":-0.0522635644214956,"8":0.030768787215760422,"9":-0.2623802625616613,"10":0.03924371514260255,"11":-0.08001901873600982}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.20452831992703455,"1":-0.4768847163547149,"2":0.13513468938195114,"3":-0.34753567411182895,"4":-0.09111064014596404,"5":0.6071157180809746,"6":0.23431597866949588,"7":0.10395724927437242,"8":0.12157533040782284,"9":-0.07090924990921836,"10":0.2066512093721522,"11":-0.33495642384278224}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.053867402054627936,"1":-0.0566005226105102,"2":0.15947806486997612,"3":-0.0013337491360707586,"4":0.06906703994259598,"5":0.3917802587487678,"6":-0.23834873954599442,"7":-0.15072441899774208,"8":0.24599529950685897,"9":-0.1388581315809237,"10":-0.05036001152746047,"11":0.18138523747700994}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.20224992715096843,"1":-0.04499129632386474,"2":-0.07921406859932353,"3":-0.4694000047936756,"4":0.039270226058132025,"5":0.5123543831200676,"6":-0.11488402650027839,"7":-0.024659405248319968,"8":-0.2980444141713839,"9":-0.06268007928537514,"10":-0.12412162488968952,"11":-0.027927435036811797}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.19504315691109,"1":-0.13229306481783515,"2":0.12295804153711386,"3":0.3246796909622576,"4":0.3035066115667341,"5":-0.07046994092636337,"6":-0.296585472025917,"7":0.1365812108485247,"8":0.01501238094472775,"9":0.7776467631595125,"10":0.1617678940574271,"11":0.9018018693009242}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.39055994215523804,"1":-0.036644168044844536,"2":0.04800180955264247,"3":0.016805140275675527,"4":0.08476553427946036,"5":-0.834301908909702,"6":-0.3269971388790022,"7":0.2434839801708684,"8":0.287091637155057,"9":-0.03462887271641896,"10":-0.06060623813459412,"11":0.1529363205548326}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.17229792886283068,"1":0.2653357606181737,"2":-0.25763987920509135,"3":0.3888089277651572,"4":-0.3187970643423186,"5":-0.08640174315091267,"6":0.42597063846854155,"7":-0.3649722090824476,"8":-0.15831654232335846,"9":-0.42650162872218483,"10":0.4638741573467772,"11":0.2915564248362247}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.4250093934271541,"1":-0.0034954975633236874,"2":-0.23750613486045877,"3":0.1785801145676367,"4":-0.25306093454155115,"5":-0.10655401602088736,"6":-0.1966718391423878,"7":0.20476561737288665,"8":-0.028536194551924677,"9":0.3372850199320976,"10":0.3217235318353725,"11":0.9996323789591627}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.22892264230846943,"1":0.29479499095026884,"2":0.19045402763195515,"3":-0.5704657757990169,"4":-0.023922124623149285,"5":-0.3064109524971278,"6":-0.06372559908349847,"7":0.3721690215010504,"8":-0.6834194824361253,"9":-0.10859618617152933,"10":0.7385395283952069,"11":0.43523077288730216}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.029614566863944494,"1":-0.17278589235952274,"2":0.12974505335972464,"3":-0.0032796430709475847,"4":0.3490048374872747,"5":-0.040923432876197374,"6":0.19896389298076392,"7":0.3138053755528192,"8":0.12213535194096142,"9":-0.02889267202694912,"10":0.3083245620741839,"11":0.2023406097597278}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.3827976057880432,"1":-0.23760667987238526,"2":0.32525018662285476,"3":-0.07642098836840215,"4":0.20587696305373182,"5":0.2525392193105852,"6":0.42937052866333186,"7":-0.544990484044866,"8":0.22492164715650556,"9":-0.1441644990773369,"10":0.14188856862106802,"11":-0.23845247324009725}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.43634392658028354,"1":-0.16208658560790115,"2":-0.09398282144815161,"3":0.05280019061725222,"4":0.21409081571088823,"5":-0.29204753783755916,"6":0.5098135934206789,"7":-0.18134266886336994,"8":0.5368301927656541,"9":-0.3066583180381192,"10":0.46878792752049153,"11":-0.005464381096191299}}],"biases":{"sx":1,"sy":1,"depth":20,"w":{"0":0.03385983323243864,"1":-0.012858234875886467,"2":0.0662861288370201,"3":0.02413581720490893,"4":-0.04594809032216664,"5":0.07272268761345461,"6":-0.10411774897030696,"7":0.054926687467434836,"8":-0.014563041312300486,"9":0.03742870716405899,"10":-0.04236840626025952,"11":0.03682612288128624,"12":-0.1375195158234018,"13":-0.16522288981846234,"14":-0.03161128781535633,"15":-0.07365861056551155,"16":-0.04224392443129382,"17":-0.07099541661826414,"18":-0.05850358109100088,"19":0.018663911441390922}}},{"out_depth":5,"out_sx":1,"out_sy":1,"layer_type":"fc","num_inputs":20,"l1_decay_mul":0,"l2_decay_mul":1,"filters":[{"sx":1,"sy":1,"depth":20,"w":{"0":-0.010875097994802732,"1":-0.39938722958445605,"2":-0.006622950172997735,"3":0.014029956019534925,"4":0.013901566825520241,"5":0.15171728685876215,"6":0.1276811504065781,"7":0.19763847943436375,"8":-0.37502896176574596,"9":-0.1558206400795782,"10":-0.22945120640376207,"11":0.17898719933318405,"12":0.23053883923502752,"13":-0.16991864028898257,"14":0.025650787663708555,"15":0.44555194022430594,"16":0.197311837586317,"17":0.009718111484097743,"18":-0.17824765527296912,"19":-0.10996026223355002}},{"sx":1,"sy":1,"depth":20,"w":{"0":0.24913224086690477,"1":-0.2814622986036609,"2":0.13335385261779928,"3":-0.06450872699810994,"4":-0.09446320033396155,"5":0.1387305582210459,"6":0.006895016173928075,"7":0.18272820389099853,"8":0.04053148397187223,"9":-0.11630146633310205,"10":-0.20190442716574247,"11":-0.18806691159387684,"12":0.35163832615361873,"13":-0.21003917134240316,"14":0.05762137999775499,"15":0.5643921179818758,"16":0.064773497403845,"17":-0.08134340280966286,"18":-0.16048275327921357,"19":-0.19839910794750604}},{"sx":1,"sy":1,"depth":20,"w":{"0":-0.08906519033503682,"1":-0.6333311938532454,"2":0.11252481087498753,"3":0.012149106468623407,"4":-0.16040150187744134,"5":0.15733145734791354,"6":-0.15778268807471613,"7":-0.04276629845189058,"8":-0.16039302118302307,"9":-0.174308139276265,"10":-0.14611544471416343,"11":0.3400960799702003,"12":0.3735810122165479,"13":0.08268492338958948,"14":-0.021432914317873857,"15":0.3723162946653711,"16":0.3092308158112485,"17":-0.16338373820335914,"18":-0.15000093348317894,"19":-0.00023918428216496664}},{"sx":1,"sy":1,"depth":20,"w":{"0":0.08323432367565671,"1":-0.31452076546355734,"2":-0.2618240617960595,"3":-0.3941620422586261,"4":-0.1914288666077001,"5":0.08386818448615993,"6":0.23910340108405373,"7":-0.2624987475677974,"8":0.2662122777518162,"9":-0.10657230311222807,"10":0.5510323277006401,"11":-0.05910710729353931,"12":0.5016733575996108,"13":-0.09277770729564701,"14":0.1238480112443671,"15":0.29346504900499104,"16":-0.15606887092484628,"17":0.14223025192912955,"18":-0.4892615045620762,"19":-0.28330148358186635}},{"sx":1,"sy":1,"depth":20,"w":{"0":0.23241271534554636,"1":-0.3629875454326679,"2":0.11307854296676177,"3":-0.12044729042315339,"4":-0.09023009305308062,"5":0.18627960007632463,"6":-0.14973526234238013,"7":0.3983896050085678,"8":-0.021605240431013504,"9":-0.07146400886141871,"10":0.21265216213357252,"11":-0.06882519436237518,"12":0.2309596073229402,"13":-0.35680115457228967,"14":-0.004560459807942869,"15":0.5843867878795289,"16":0.31614881010240353,"17":-0.10161211041169053,"18":-0.22333688687157333,"19":-0.07501927721113183}}],"biases":{"sx":1,"sy":1,"depth":5,"w":{"0":0.09904620296217322,"1":0.15153855934860744,"2":0.10425243486956606,"3":0.06454320788270988,"4":0.06678423526366668}}},{"out_depth":5,"out_sx":1,"out_sy":1,"layer_type":"regression","num_inputs":5}]}

   </textarea>
  
  
  
  <div id="gui4"><p>Scene3</p></div>
  <br>
  <textarea id="scene3" style="width:100%; height:200px;">
    {"layers":[{"out_depth":12,"out_sx":1,"out_sy":1,"layer_type":"input"},{"out_depth":20,"out_sx":1,"out_sy":1,"layer_type":"fc","num_inputs":12,"l1_decay_mul":0,"l2_decay_mul":1,"filters":[{"sx":1,"sy":1,"depth":12,"w":{"0":-0.4575949107786406,"1":0.5726254693510469,"2":0.39942767925180844,"3":-0.07842474446194023,"4":-0.05154349980406469,"5":0.16643100060211724,"6":-0.34651953264427027,"7":-0.16519132569870087,"8":0.08486222489199693,"9":0.6351250315702136,"10":-0.18903711210998822,"11":0.17781015609923206}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.2377932592894897,"1":0.05338631525863566,"2":-0.4996644861942387,"3":-0.02665567582668741,"4":0.2594521490911294,"5":-0.29866740411693804,"6":0.03553484900908748,"7":0.045638336477818855,"8":0.40702973756473904,"9":0.009632000791339966,"10":0.0425812911824583,"11":0.34748912607214766}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.012840160300385097,"1":0.015534290999315761,"2":0.21326015180937188,"3":0.017684308104205418,"4":0.22394726190502898,"5":-0.06908357417684793,"6":0.1695075035860221,"7":-0.33053620837793857,"8":-0.1647301509856918,"9":-0.06734723521474556,"10":-0.02430816598448787,"11":-0.35431831126501756}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.15404101792800012,"1":-0.09404024684521828,"2":0.04002361408592444,"3":0.40299577127831177,"4":0.28186890956852,"5":-0.18459297279239248,"6":-0.34179015004462254,"7":-0.18632087008152756,"8":0.06048488341211903,"9":0.4908098708528323,"10":0.13755042788992708,"11":0.32549717391183214}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.15548447609358376,"1":0.4627204889204685,"2":-0.042963505098905314,"3":0.3550262639947814,"4":-0.011216310471565558,"5":-0.15960593487011188,"6":0.23689149410888613,"7":-0.12090477566955586,"8":0.12578366986107511,"9":0.9034916967992862,"10":-0.4954882334565913,"11":-0.15886455775166808}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.3260739120641359,"1":-0.4457457338147453,"2":0.04968055429246351,"3":0.30578757413697855,"4":0.00079112289499525,"5":-0.06580962878217952,"6":0.4599430236689604,"7":-0.027899703216288055,"8":0.46623296067042064,"9":0.25463076939475665,"10":-0.07068351280103156,"11":-0.009569364771290386}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.18791038576144026,"1":-0.042848808722265506,"2":-0.11268484359475292,"3":-0.031454618279262866,"4":-0.24864222878228398,"5":-0.022678050099246748,"6":-0.18639800243122612,"7":-0.5910982229131024,"8":0.13527783736383703,"9":-0.4548074892185775,"10":-0.37501307735058553,"11":0.4934316124442917}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.08806030369239015,"1":-0.49896458505501073,"2":-0.045747747931897856,"3":-0.2674601995436228,"4":0.1693971948233612,"5":-0.1563128217314284,"6":-0.7211024709523439,"7":0.5526854527666425,"8":0.23816737891003284,"9":0.017531896208710554,"10":0.21133417775369234,"11":0.39426324393191353}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.21376940220367296,"1":-0.08810726725598064,"2":0.07273076311385868,"3":0.6497390928515704,"4":-0.14408637589023077,"5":-0.1741164091188595,"6":0.10423084031660708,"7":0.25575984104793004,"8":-0.2672441940915386,"9":0.2714040836078451,"10":-0.11495881924803326,"11":-0.0453759824073447}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.2627043877967662,"1":0.14349197870972666,"2":0.22228759513202004,"3":0.5620719805407349,"4":-0.19144396704687883,"5":0.1901934639489395,"6":-0.5187149168502565,"7":-0.24567923293119937,"8":-0.39177907137012624,"9":0.32301370584408534,"10":-0.017310147724079666,"11":0.25833600615409585}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.09606489647687629,"1":-0.23078427343587893,"2":-0.236779857196514,"3":-0.2191064518257826,"4":0.09036557634884591,"5":-0.2914134437887145,"6":0.2675393405736427,"7":-0.29858238159488587,"8":-0.12672691606397954,"9":-0.3433975421177316,"10":0.2147589724251325,"11":-0.2267073962586461}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.1745384362664242,"1":-0.14304139154973017,"2":0.0981055474899711,"3":0.024064247705494327,"4":-0.272309024659336,"5":-0.011039710541637332,"6":-0.16116261713350413,"7":0.20548282825568057,"8":-0.6017835373648015,"9":0.9131461892804899,"10":-0.19470877898764372,"11":-0.2546510822218436}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.18368328446448443,"1":0.638960389391346,"2":0.3733605198353668,"3":-0.19913453629272324,"4":-0.4176538232479872,"5":-0.32885308720868683,"6":0.14437601735542405,"7":-0.20004860575728803,"8":-0.08090345499931284,"9":0.08407054526411875,"10":-0.6087310501766203,"11":-0.12686876523054239}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.09844741302573128,"1":0.23774543505292733,"2":0.40977367513346896,"3":0.067699512455133,"4":0.1590521937141162,"5":-0.26479106976469713,"6":-0.16485541921311014,"7":-0.04939966483369333,"8":-0.6241188969998386,"9":-0.003959380691601615,"10":0.17470187772841886,"11":-0.06880908724068413}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.3356463347206879,"1":0.30346603995305915,"2":0.10291400427965369,"3":-0.400564247404083,"4":-0.15168204251530562,"5":-0.06698754097628955,"6":0.05551494079101768,"7":0.27095486527104357,"8":0.031561904633617084,"9":0.15660074753310194,"10":-0.20651785229302105,"11":0.6505541305452095}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.39744974657959026,"1":0.011622184444637569,"2":0.4729456728557396,"3":0.21959906952415867,"4":0.35284846541789106,"5":-0.10724971088167182,"6":0.21031396843404157,"7":-0.19315486093215192,"8":0.19856044976234274,"9":-0.8394800230788556,"10":0.12849928152384918,"11":0.18796642030082286}},{"sx":1,"sy":1,"depth":12,"w":{"0":-0.145125432093264,"1":-0.18332885620286718,"2":-0.1532211536149021,"3":-0.4177034412253769,"4":0.09325642895261407,"5":0.5753661697659678,"6":-0.22131224540969363,"7":-0.0624434349479981,"8":0.4271504747786471,"9":-0.3690908397450727,"10":-0.0380997394524984,"11":0.11096311133819872}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.37193905896762014,"1":0.35812815197182396,"2":-0.011708353884873799,"3":0.22856161155484203,"4":0.29146483851873367,"5":0.44064355344783346,"6":-0.12709303910384542,"7":-0.2480590350776664,"8":0.3693449027948057,"9":0.11258860336033612,"10":-0.2707462012064663,"11":-0.027149767031321086}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.3982168352579452,"1":-0.3653935506677248,"2":0.5272840913185344,"3":-0.03510171273376339,"4":0.12883326263776393,"5":0.11999428377746199,"6":-0.1767557961580266,"7":0.0547222081870948,"8":0.20919296375018212,"9":-0.17967231890445443,"10":0.15410348392164439,"11":0.18050546685585853}},{"sx":1,"sy":1,"depth":12,"w":{"0":0.6471696633953978,"1":0.4609036502934755,"2":-0.1167621402457531,"3":0.009466957935267882,"4":-0.1961777045037224,"5":-0.4587742858357553,"6":-0.42061340608021397,"7":0.3454282612343188,"8":-0.29563816714649666,"9":0.16036051899215287,"10":0.23233101979112503,"11":-0.26945567342736054}}],"biases":{"sx":1,"sy":1,"depth":20,"w":{"0":-0.06892056114404742,"1":-0.05386581717143637,"2":0.05203053475793261,"3":-0.02056633197302399,"4":0.008668324115962878,"5":-0.04099272483855,"6":-0.0042802887048665516,"7":-0.011422304468782772,"8":0.05052263431208673,"9":0.04104080055735941,"10":-0.026672476428532366,"11":-0.026382609742217338,"12":0.049685853942288256,"13":0.07129238664550852,"14":-0.01269744837328027,"15":-0.011825592580470768,"16":0.040193177221957914,"17":-0.0033677247171563017,"18":0.041253715193532145,"19":0.041914506533400196}}},{"out_depth":5,"out_sx":1,"out_sy":1,"layer_type":"fc","num_inputs":20,"l1_decay_mul":0,"l2_decay_mul":1,"filters":[{"sx":1,"sy":1,"depth":20,"w":{"0":-0.07104292398421229,"1":-0.22599926428685316,"2":0.05299085799662571,"3":-0.07855468748436754,"4":0.08680955278104843,"5":0.17583067075855183,"6":-0.1586624732738155,"7":-0.21959734173751796,"8":-0.0021779705063410945,"9":0.3443765813792447,"10":-0.12035962576297322,"11":0.3361744969337531,"12":-0.08150123766842766,"13":0.0915975552110999,"14":0.165331472919499,"15":-0.6762036852796292,"16":0.07256205218415619,"17":0.10201685003429686,"18":0.16892777292818514,"19":0.08691148669406888}},{"sx":1,"sy":1,"depth":20,"w":{"0":0.39176921718440694,"1":0.10912925890450996,"2":0.07593985911319998,"3":-0.257423766904126,"4":0.30041212495129893,"5":-0.19376793014240987,"6":-0.3649562312778329,"7":0.08493330006628652,"8":0.359039737714461,"9":0.32807864701811906,"10":0.1790404136896154,"11":0.3555387991662111,"12":-0.1972927524112517,"13":-0.17553221757644324,"14":0.07187912093999205,"15":-0.07832974412297065,"16":-0.14708809652539276,"17":-0.026256442868977034,"18":-0.26789504892492033,"19":0.06206229971088881}},{"sx":1,"sy":1,"depth":20,"w":{"0":0.06433307679670403,"1":-0.3337037157927494,"2":-0.13174763564891978,"3":0.42273390779330305,"4":0.01700256699023925,"5":0.03125900139621043,"6":-0.23370027945599306,"7":-0.16583102165559513,"8":0.2302424857946437,"9":0.2626212071649907,"10":-0.09071301364564223,"11":0.1687032179442548,"12":0.11717651557946886,"13":-0.2082808505417496,"14":-0.032748815562086,"15":-0.3150348910396393,"16":-0.1795546171292467,"17":-0.03874661912863466,"18":-0.295110496803196,"19":0.1292502998214516}},{"sx":1,"sy":1,"depth":20,"w":{"0":0.3633805163942528,"1":-0.06867207595866903,"2":0.14409599857143837,"3":0.1992761559537041,"4":0.21983629307717908,"5":0.0708897665895971,"6":-0.18513451586457455,"7":-0.20700442500065147,"8":0.00277612882039783,"9":0.344122906765242,"10":-0.11698560909581189,"11":0.11044728116744472,"12":0.07308005655808246,"13":-0.04250749368465658,"14":-0.029123842981857436,"15":-0.17672735121954092,"16":-0.07361290536315651,"17":-0.2501053867905089,"18":-0.36598810255075515,"19":0.41458103057653073}},{"sx":1,"sy":1,"depth":20,"w":{"0":-0.11413387622925465,"1":-0.05668468269240508,"2":0.0469461580918639,"3":0.07660071781664528,"4":0.42893231534032217,"5":-0.21010746186464566,"6":-0.18567840772151795,"7":0.42154101841791275,"8":0.2889799614705364,"9":-0.11245923882343155,"10":-0.2085527769156812,"11":0.3110212970215439,"12":0.2122300909224802,"13":0.41871866950082515,"14":-0.029138687078603117,"15":-0.5040626461832992,"16":0.01428744763019812,"17":-0.15765375212107388,"18":0.05310667292990841,"19":0.2335039187568327}}],"biases":{"sx":1,"sy":1,"depth":5,"w":{"0":0.07028121034687676,"1":0.008807716759263094,"2":0.018902546966786636,"3":0.059022933570004286,"4":0.13752017747586767}}},{"out_depth":5,"out_sx":1,"out_sy":1,"layer_type":"regression","num_inputs":5}]}
   </textarea>

<script id="jsbin-javascript">
// noprotect
//
// Q learning with neural nets
// credit to Prof. M. Nelson, Apr 2017
// Hang (Yohan) Yu, Apr 2017

var itick = 0;
var bot;
var pellets = [];
var brain;
var backgroundImage; // credit :Prof.M.Melson HW4:https://jsbin.com/neyulot/1/edit?js,output
var temperature = [];

var simModes = ['keyboard','mouse','randAction','training', 'testing'];
var modeSelector; // GUI element for selecting a controller
 
var slower = 2; // # times more slower than usual
var paused = true;
var expt = null;

var NSTEPS = 2000;
var NTRIALS = 50;
var NPELLETS = 12;

var EXPT_SPEEDUP = 500;
// varibel to tell whether or not we've trained network at least once (run series). Becuase brain.foward(bot.nextState) (which predict bot's next move) is not available in a brand new network.
var trained = false;

//---------
// Vector normalization fucntion
//---------
function normalize(arr) {
  var tol = 0;
  for (var i in arr) {tol += arr[i] * arr[i];}
  tol = Math.sqrt(tol);
  for (var j in arr) {arr[j] /= tol;}
  return arr;
}
    

//---------
// HW4 MakeBackgroundImage() & getTemperature(x,y)
//---------
function makeBackgroundImage() {
  backgroundImage = createImage(width, height);
  // sinusoidal variation
  for (var iy = 0; iy < height; iy++) {
    for (var ix = 0; ix < width; ix++) {

      var temp = 0.5 + 0.7 * Math.cos(0.03 * ix) * Math.sin(0.04 * iy);
      temp = Math.min(Math.max(temp, 0), 1);
      temperature.push(temp);
      var redVal = Math.floor(255 * temp);
      var blueVal = Math.floor(255 * (1 - temp));
      var greenVal = min(redVal, blueVal);
      backgroundImage.set(ix, iy, color(redVal, greenVal, blueVal));
    }
  }
  backgroundImage.updatePixels();
}

function getTemperature(x, y) {
  var ix = constrain(Math.floor(x), 0, width - 1);
  var iy = constrain(Math.floor(y), 0, height - 1);
  var idx = ix + width * iy;
  return temperature[idx];
}


//---------
// SETUP
//---------

function reset() {
	// reset bot
	bot.x = width / 2;
	bot.y = height - 100;
	bot.setController(modeSelector.value());
	bot.energy = 0;
  bot.badPellets = 0;

	// reset pellets
	pellets = [];
  for(var i = 0; i < NPELLETS;i++) {
    pellets.push(new Pellet());
  }

	// reset sim
	itick = 0;
	paused = true;
}

function resetBrain() {
	var num_inputs = 12; //  [leftRed, leftGreen, rightRed, rightGreen, upRed, upGreen, downRed, downGreen, closeGreen, closeRed, wall,temperature]
	var num_actions = 5; // Left/Right/Stop/Up/Down
	var temporal_window = 0; // amount of temporal memory. 0 = agent lives in-the-moment :)
	var network_size = temporal_window * (num_inputs + num_actions) + num_inputs;

  // Specify Neural Network Architecture
	var layer_defs = [];
	layer_defs.push({type:'input', out_sx:1, out_sy:1, out_depth:network_size});
  // ADD HIDDEN LAYER(S) HERE
  // ...
  layer_defs.push({type:'fc', num_neurons:20, activiation:'sigmoid'});
  
  // output layer:
	layer_defs.push({type:'regression', num_neurons: num_actions});

	// options for the learning algorithm (feel free to edit these)
	var opt = {};
	opt.temporal_window = temporal_window;
	opt.experience_size = NSTEPS * NTRIALS;
	opt.start_learn_threshold = 2000;
	opt.gamma = 0.95;
	opt.learning_steps_total = 60000;
	opt.learning_steps_burnin = 10000;
	opt.epsilon_min = 0.1;
	opt.epsilon_test_time = 0.0;
	opt.layer_defs = layer_defs;
	opt.tdtrainer_options = {learning_rate:0.001, momentum:0.0, batch_size: 50, l2_decay:0.001};

	brain = new deepqlearn.Brain(num_inputs, num_actions, opt);
}

function setup() {
	createCanvas(300, 300).parent('canvas');
  
  // make the background image (temperature map)
  makeBackgroundImage();
  
  // Create buttons/selectors/textWindow that stores neural network 
	createGUI();
	
  // Create a Bot
  bot = new Bot();
  
  // reset deepqlearn.Brain
	resetBrain();
	
  // reset scene
  reset();
}

//------------
// MAIN LOOP
//------------
function mouse() {
	// mouse light handler
	if (mouseIsPressed) {
		dx = mouseX - bot.x;
		dy = mouseY - bot.y;
    dd = sqrt(dx*dx + dy*dy);
    if (dd < 1) {
      bot.vx = 0;
      bot.vy = 0;
    } else {
      bot.vx += 5 * dx / dd;
      bot.vy += 5 * dy / dd;
    }
	}
}

function keyTyped() {
  if (key == 'n') {
    reset();
    togglePause();
  } else if (key == 'a') {
    bot.vx -= 5;
  } else if (key == 's') {
    bot.vy += 5;
  } else if (key == 'd') {
    bot.vx += 5;
  } else if (key == 'w') {
    bot.vy -= 5;
  } else if (key == ' ') {
    bot.vy = 0;
    bot.xy = 0;
  }
}

var n = 1;

function draw() {
	
  // show backgroundImage (temperature map)
  if (bot.temperatureReward !== 0.0){
    image(backgroundImage, 0, 0);
  } else {
    background(0);
  }
  
  if (bot.enableElectricWall) {
    //noStroke();
    fill('yellow');
    rect(0,0,width,5);
    rect(0,height-5,width,5);
    rect(0,0,5,height);
    rect(width-5,0,5,height);
  }
	for (var i=0; i<pellets.length; i++) {pellets[i].display();}
	bot.display();
	displayInfo();

	if (expt) {
		expt.update();
		expt.display();
		if (expt.isFinished()) {
			bot.setController(modeSelector.value());
			reset();
			expt = null;
		}
	} else {
		if (paused || itick >= NSTEPS) {
			select('#status').html('paused');
			noLoop();
		} else {
      
			if (n % slower === 0) {
        n = 1;
				simStep();
				//if (itick >= NSTEPS) break;
			} else {
        n += 1;
      }
		}
	}
}

function simStep() {
  itick++;
  for (var i=0; i<pellets.length; i++) {pellets[i].update();}
  bot.update();
}

//---------
// DISPLAY
//---------



function displayInfo() {
	push();
	textSize(14);
	noStroke();
	fill('white');
	textAlign(LEFT);
	text(bot.controllerName, 15, 30);
	textAlign(CENTER);
	text("energy = " + nf(bot.energy,2,2), width / 2, 30);
  textAlign(CENTER);
  text("hit by bad pellets = " + nf(bot.badPellets), width / 2, 45);
	textAlign(RIGHT);
	text(itick, width - 15, 30);
	pop();
}
//-------
// GUI
//-------
function createGUI() {
  
  // show the Q arry of the current state of bot
  myQ = createDiv("[LEFT, RIGHT, UP, DOWN, STOP]=>best action is: undefined");
  myQ.parent('myQ');

	// RESET BRAIN
	var qBtn = createButton('reset Brain').parent('#gui');
	qBtn.mousePressed(function() {
		resetBrain();
	});

	// CONTROLLER SELECTOR
	modeSelector = createSelect().parent('#gui');
	for (var i = 0; i < simModes.length; i++) {
		modeSelector.option(simModes[i]);
	}
	modeSelector.changed(function() {
		var val = this.value();
		bot.setController(val);
		if(val === "training") {brain.learning = true;}
		if(val === "testing")  {brain.learning = false;}
		reset();
		redraw();
	});

	// RESET
	var resetBtn = createButton('reset').parent('#gui');
	resetBtn.mousePressed(function() {
		reset();
		redraw();
	});

	// SINGLE STEP
	var stepBtn = createButton('single step').parent('#gui');
	stepBtn.mousePressed(function() {
		simStep();
		redraw();
	});

	// RUN/PAUSE
	var runBtn = createButton('run/pause').parent('#gui');
	runBtn.mousePressed(togglePause);

	// RUN SERIES
	var exptBtn = createButton('run series').parent('#gui');
	exptBtn.mousePressed(function() {
		expt = new Expt(EXPT_SPEEDUP);
		loop();
	});
  
  // credit: Prof.M.Nelson HW4:https://jsbin.com/neyulot/1/edit?js,output
  // faster input (controls number of simulation updates per screen refresh)
  var fasterLabel = createSpan(' slower:');
  fasterLabel.parent('#gui');
  var fasterInput = createInput(slower);
  fasterInput.parent('#gui');
  fasterInput.attribute('id', 'fasterInput'); // add 'id' so we can find it later
  fasterInput.style("width", "40px");
  fasterInput.input(function() {
    slower = this.value();
    redraw();
  });
  
  // ENABLE / DISABLE Electric Fence
  var wallSelect = createSelect().parent('#gui');
  wallSelect.option('Electric Fence Disable');
  wallSelect.option('Electric Fence Enable');
  
	wallSelect.changed(function() {
    var val = this.value();
    if (val === "Electric Fence Enable") {
      bot.enableElectricWall = true;
    } else {
      bot.enableElectricWall = false;
    }
    reset();
    redraw();
  });
  
  // ENABLE / DISABLE Electric Fence
  var sceneSelect = createSelect().parent('#gui');
  sceneSelect.option('Scene 1 - temperature reward high');
  sceneSelect.option('Scene 2 - temperature reward low');
  sceneSelect.option('Scene 3 - no temperature reward');
  
	sceneSelect.changed(function() {
    var val = this.value();
    if (val === "Scene 1 - temperature reward high") {
      bot.temperatureReward = 0.25;
    } else if (val === "Scene 2 - temperature reward low"){
      bot.temperatureReward = 0.05;
    } else {
      bot.temperatureReward = 0.0;
      bot.pelletsRewardMultipler = 1.0;
    }
    reset();
    redraw();
  });
  
	//-------
	// GUI2
	//-------

	// Save network
	var saveBtn = createButton('save network').parent('#gui2');
	saveBtn.mousePressed(function() {
	  var j = brain.value_net.toJSON();
	  var t = JSON.stringify(j);
	  select('#scene1').html(t);
	});

	// Load network
	var loadBtn = createButton('load network').parent('#gui2');
	loadBtn.mousePressed(function() {
	  var t = select('#scene1').html();
	  var j = JSON.parse(t);
	  brain.value_net.fromJSON(j);
	});
  
  //-------
	// GUI3
	//-------

	// Save network
	var saveBtn2 = createButton('save network').parent('#gui3');
	saveBtn2.mousePressed(function() {
	  var j = brain.value_net.toJSON();
	  var t = JSON.stringify(j);
	  select('#scene2').html(t);
	});

	// Load network
	var loadBtn2 = createButton('load network').parent('#gui3');
	loadBtn2.mousePressed(function() {
	  var t = select('#scene2').html();
	  var j = JSON.parse(t);
	  brain.value_net.fromJSON(j);
	});
  
  //-------
	// GUI4
	//-------

	// Save network
	var saveBtn3 = createButton('save network').parent('#gui4');
	saveBtn3.mousePressed(function() {
	  var j = brain.value_net.toJSON();
	  var t = JSON.stringify(j);
	  select('#scene3').html(t);
	});

	// Load network
	var loadBtn3 = createButton('load network').parent('#gui4');
	loadBtn3.mousePressed(function() {
	  var t = select('#scene3').html();
	  var j = JSON.parse(t);
	  brain.value_net.fromJSON(j);
	});

}

function togglePause() {
	paused = !paused;
	if (!paused) {
		select('#status').html('running');
		loop();
	}
}

//-------------
// EXPERIMENT
//------------

function Expt(speedup) {

	// run a set of trials for the currently selected controller
	// and enter stats in the data table

	this.done = false;
	this.itrial = 0;
	this.speedup = speedup;
	this.fitDat = [];

	reset();

	this.update = function() {

		// take n simulation steps
		var n = this.speedup;
		while (n--) {
			simStep();
			if (itick >= NSTEPS) break;
		}

		// update display
		this.display();

		if (itick >= NSTEPS) {
			// finished trial
			this.fitDat.push(bot.energy);
			reset();
			this.itrial++;
			if (this.itrial == NTRIALS) {
				// finished series
				var stats = calcArrayStats(this.fitDat);
				var buf = select('#table').html(); // get existing table data
				buf += "<tr>"; // add a new row
				buf += "<td>" + bot.controllerName + "</td>";
				buf += "<td>" + nf(stats.mean, 1, 2) + " (" + nf(stats.std, 1, 2) + ")" + "</td>";
				buf += "</tr>";
				select('#table').html(buf); // put it back in the table
        
        // The condition below indicates the network has been trained
        if (bot.controllerName == "training" && !trained) {
          trained = true;
        }
        
				this.done = true;
				reset();
			}
		}

	};

	this.display = function() {
		select('#status').html(bot.controllerName + " trial/tick: " + [this.itrial, itick]);
	};

	this.isFinished = function() {
		return this.done;
	};
}

//------------
// UTILITIES
//------------

function calcArrayStats(inputArray) {
	/**
	 ** calculates mean, standard deviation and standar error 
	 **
	 ** input: inputArray, an array of numbers
	 ** returns: {mean: <mean>, std: <standard deviation>, sem: <standard error>}
	 */
	var sum = 0;
	var sumSq = 0;
	var n = inputArray.length;
	for (var i = 0; i < n; i++) {
		sum += inputArray[i];
		sumSq += inputArray[i] * inputArray[i];
	}
	var variance = (sumSq - (sum * sum) / n) / (n - 1);
	return {
		mean: sum / n,
		std: Math.sqrt(variance),
		sem: Math.sqrt(variance / n)
	};
}

function randint(min,max) {
	// return a random integer N such that min <= N <= max
    return Math.floor(Math.random()*(max-min+1)+min);
}

//------
// Bot
//------

// Bot constructor
function Bot(parms) {
  parms = parms || {};
  this.halfWidth = parms.halfWidth || 10;
  this.y = parms.y || height - 150;
  this.x = parms.x || random(this.halfWidth, width-this.halfWidth);
  this.vx = 0; // x velocity
  this.vy = 0;
  this.cfill = 'darkOrange';
  this.energy = 0;
  this.badPellets = 0;
  this.enableElectricWall = false;
  this.temperatureReward = 0.25;
  this.pelletsRewardMultipler = 1;


  this.controllerName = '';
  if (typeof parms.controller === 'string') {
    this.setController(parms.controller);
  }

  this.sns = {
    left: [0, 0], // RED, GREEN
    right: [0, 0], 
    up: [0, 0],
    down: [0,0],
    close: [0,0], // sns that is activated for pellets < 30 units.
    wall: [0],
    temp: [0]
  };

  // action values
  this.LEFT = 0;
  this.RIGHT = 1;
  this.STOP = 2;
  this.UP = 3;
  this.DOWN = 4;

  // reinforcement learning
  this.state = [0, 0];
  this.action = 0;
  this.reward = 0;
  this.nextState = [0, 0];
}

// a function for bot to consume pellets
Bot.prototype.consume = function() {
  // temperature reward/punishment
  this.reward += this.temperatureReward * (getTemperature(this.x,this.y) - 0.5);
  //print(getTemperature(this.x,this.y));
  
  // pellet consumption
  for (var i = 0; i < pellets.length; i++) {
    var dcheck = this.halfWidth + pellets[i].dia / 2;
      // comsume == TRUE in the case below
      if (dist(pellets[i].x,pellets[i].y,this.x,this.y) < dcheck){
      this.reward += this.pelletsRewardMultipler * pellets[i].value;
      if (pellets[i].value < 0) {
        this.badPellets += 1;
      }
      pellets[i].reset();
    }
  }
  this.energy += this.reward;
};

// a function for bot to update status every frame
Bot.prototype.update = function() {
  
  this.reward = 0;
  this.state = this.getSensorState();
  this.controller();
  
  // x-axis motion
  this.vx *= 0.98;
  this.vx = constrain(this.vx, -2.5, 2.5);
  this.x += this.vx;
  if (this.x < this.halfWidth) {
    this.x = this.halfWidth;
    // punish hitting the wall
    if (this.enableElectricWall) {
      //this.vx = 10;
      this.reward -= 2 * this.halfWidth / min(this.x,this.y,width - this.x, height - this.y);
    }
  } else if (this.x > width - this.halfWidth) {
    this.x = width - this.halfWidth;
    // punish hitting the wall
    if (this.enableElectricWall) {
      //this.vx = -10;
      this.reward -= 2 * this.halfWidth / min(this.x,this.y,width - this.x, height - this.y);
    }
  }
  
  
  // y-axis motion
  this.vy *= 0.98;
  this.vy = constrain(this.vy, -2.5, 2.5);
  this.y += this.vy;
  if (this.y < this.halfWidth) {
    this.y = this.halfWidth;
    // punish hitting the wall
    if (this.enableElectricWall) {
      //this.vy = 10;
      this.reward -= 2 * this.halfWidth / min(this.x,this.y,width - this.x, height - this.y);
    }
  } else if (this.y > height - this.halfWidth) {
    this.y = height - this.halfWidth;
    // punish hitting the wall
    if (this.enableElectricWall) {
      //this.vy = -10;
      this.reward -= 2 * this.halfWidth / min(this.x,this.y,width - this.x, height - this.y);
    }
  }
  
  this.consume();
  this.updateSensors();
  this.nextState = this.getSensorState();
  var actionDict = {0: "LEFT", 1:"RIGHT", 2:"STOP", 3:"UP", 4:"DOWN"};
  if (this.controllerName == "training") {
    brain.backward(this.reward);
    
    if (trained){
      myQ.html(" [LEFT, RIGHT, UP, DOWN, STOP]=> Trained network, the best action is: " + actionDict[brain.forward(this.state)]);
    } else {
      myQ.html(" [LEFT, RIGHT, UP, DOWN, STOP]=> Brand new network, the best action is: " + actionDict[brain.forward(this.state)]);
    }
  }
  // Show best action in "testing" model as well
  if (this.controllerName == "testing") {
    // My code
    if (trained){
      myQ.html(" [LEFT, RIGHT, UP, DOWN, STOP]=>Trained network, best action is: " + actionDict[brain.forward(this.nextState)]);
    } else {
      myQ.html(" [LEFT, RIGHT, UP, DOWN, STOP]=> Brand new network, the best action is: " + actionDict[brain.forward(this.state)]);
    }
  }
};

Bot.prototype.updateSensors = function() {
  this.sns.left = [0, 0];
  this.sns.right = [0, 0];
  this.sns.up = [0, 0];
  this.sns.down = [0, 0];
  this.sns.close = [0, 0];
  this.sns.wall = [0];
  this.sns.temp = [0];
  
  this.sns.temp[0] += getTemperature(this.x,this.y);
  
  if (this.x - 0 < 50 || width - this.x < 50 || this.y - 0 < 50 || height - this.y < 50) {
    this.sns.wall[0] += 2 * this.halfWidth / min(this.x,this.y,width - this.x, height - this.y);
  }
  
  for (var i=0; i < pellets.length; i++) {
    var idx = (pellets[i].color == 'red') ? 0 : 1;
    this.sns.left[idx] += 30.0 / dist(this.x - this.halfWidth, this.y, pellets[i].x, pellets[i].y);
    this.sns.right[idx] += 30.0 / dist(this.x + this.halfWidth, this.y, pellets[i].x, pellets[i].y);
    this.sns.up[idx] += 30.0 / dist(this.x, this.halfWidth + this.y, pellets[i].x, pellets[i].y);
    this.sns.down[idx] += 30.0 / dist(this.x, this.y - this.halfWidth, pellets[i].x, pellets[i].y);
    if (dist(this.x, this.y, pellets[i].x, pellets[i].y) < 60){
    this.sns.close[idx] += 30.0 / dist(this.x, this.y, pellets[i].x, pellets[i].y);
    }
  }
};

Bot.prototype.getSensorState = function() {
  return normalize(this.sns.left.concat(this.sns.right).concat(this.sns.up).concat(this.sns.down).concat(this.sns.close).concat(this.sns.wall).concat(this.sns.temp));
};

Bot.prototype.display = function() {
  push();
  fill(this.cfill); 
  //translate(this.x, this.y);
  ellipse(this.x, this.y, 2*this.halfWidth, 2*this.halfWidth);
  
  pop();
};

Bot.prototype.setController = function(name) {
  this.controllerName = name;
  this.controller = this[name];
};


//-------------
// CONTROLLERS 
//-------------

Bot.prototype.randAction = function() {
  // pick a random action
  this.action = randint(0, 4);
  this.actionToMotor();
};

Bot.prototype.training = function() {
  this.action = brain.forward(this.state);
  this.actionToMotor();
};

Bot.prototype.testing = function() {
  this.action = brain.forward(this.state);
  this.actionToMotor();
};

Bot.prototype.keyboard = function() {
};

Bot.prototype.mouse = function() {
  mouse();
};

Bot.prototype.actionToMotor = function() {
  if (this.action == this.LEFT) {
    this.vx -= 5;
  } else if (this.action == this.RIGHT) {
    this.vx += 5;
  } else if (this.action == this.STOP) {
    this.vx = 0;
    this.vy = 0;
  } else if (this.action == this.UP) {
    this.vy += 5;
  } else if (this.action == this.DOWN) {
    this.vy -= 5;
  }
};


//---------
// Pellet
//---------

// Pellet constructor

function Pellet() {
    this.reset();
}

Pellet.prototype.display = function() {
	//noStroke();
	fill(this.color);
	ellipse(this.x, this.y, this.dia, this.dia);
};

Pellet.prototype.reset = function() {
  
  this.dia = 10;
  this.color = (random() < 0.3) ? 'red' : 	'#7FFF00';  // red = bad (-1); green = good (+1)
  this.value = (this.color == 'red') ? -1 : 1;
  
  var xbuffer = (this.color == 'red') ? 10 : 10;  // provide safe zones from red pellets
  if (random() < 0.5) {
    // 50% goes through the screen vertical or horizontally
    if (random() < 0.5) {
      // 50% goes through the screen in either up or down (for horizontal pellets: left or right)
      this.x = random(xbuffer, width - xbuffer);
      this.y = 10;
      this.vy = random(2,4);
      this.vx = random(-1,1);
    } else {
      this.x = random(xbuffer, width - xbuffer);
      this.y = height - 10;
      this.vy = -random(2,4);
      this.vx = random(-1,1);
    }
  } else {
    if (random() < 0.5) {
      this.x = 10;
      this.y = random(xbuffer, width - xbuffer);
      this.vy = random(-1,1);
      this.vx = random(2,4);
    } else {
      this.x = width - 10;
      this.y = random(xbuffer, width - xbuffer);
      this.vy = random(-1,1);
      this.vx = -random(2,4);
    }
  }
};

Pellet.prototype.update = function() {
	this.y += this.vy;
	if (this.y > height || this.y < 0) this.reset();
  this.x += this.vx;
	if (this.x > width || this.x < 0) this.reset();
};
</script>
</body>
</html>